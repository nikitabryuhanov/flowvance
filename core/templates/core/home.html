{% extends 'base.html' %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è | Flowvance{% endblock %}

{% block content %}
<div class="p-5 bg-white rounded shadow text-center mb-5">
    <h1 class="display-5 mb-3">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ <span class="text-primary">Flowvance</span>!</h1>
    <p class="lead">–£–ø—Ä–∞–≤–ª—è–π –∑–∞–¥–∞—á–∞–º–∏, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.</p>

    <div class="row row-cols-1 row-cols-md-3 g-3 mt-4">
        <div class="col">
            <a href="{% url 'tasks' %}" class="btn btn-primary btn-lg w-100">–ó–∞–¥–∞—á–∏</a>
        </div>
        <div class="col">
            <a href="{% url 'activity' %}" class="btn btn-primary btn-lg w-100">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</a>
        </div>
        <div class="col">
            <a href="{% url 'profile' %}" class="btn btn-primary btn-lg w-100">–ü—Ä–æ—Ñ–∏–ª—å</a>
        </div>
    </div>
</div>

{% if page_obj and page_obj.object_list %}
<!-- –ë–ª–æ–∫ —Å –∑–∞–¥–∞—á–∞–º–∏ -->
<div class="bg-white p-4 rounded shadow mb-5" id="task-cards">
    {% include 'core/includes/_task_cards.html' %}
</div>
{% endif %}

<!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->
<div class="bg-white p-4 rounded shadow mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
        <h4 class="mb-0">
            <a href="{% url 'activity' %}" class="text-decoration-none text-dark">üìä –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –∑–∞–¥–∞—á</a>
        </h4>
        <div class="d-flex gap-2 flex-wrap">
            <div class="form-check form-check-inline">
                <input class="form-check-input status-toggle" type="checkbox" checked id="toggle-done" data-index="0">
                <label class="form-check-label" for="toggle-done">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input status-toggle" type="checkbox" checked id="toggle-progress" data-index="1">
                <label class="form-check-label" for="toggle-progress">üöß –í –ø—Ä–æ—Ü–µ—Å—Å–µ</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input status-toggle" type="checkbox" checked id="toggle-planned" data-index="2">
                <label class="form-check-label" for="toggle-planned">üïì –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</label>
            </div>
        </div>
    </div>
    <canvas id="statusChart" height="120"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('statusChart').getContext('2d');
const allLabels = ['–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ', '–í –ø—Ä–æ—Ü–µ—Å—Å–µ', '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'];
const allData = [{{ planned }}, {{ in_progress }}, {{ completed }}];
const allColors = ['rgba(220, 53, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(40, 167, 69, 0.7)'];

const statusChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: [...allLabels],
        datasets: [{
            label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á',
            data: [...allData],
            backgroundColor: [...allColors],
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

    document.querySelectorAll('.status-toggle').forEach(toggle => {
        toggle.addEventListener('change', function () {
            const index = parseInt(this.dataset.index);
            const dataset = statusChart.data.datasets[0];

            if (this.checked) {
                statusChart.data.labels[index] = allLabels[index];
                dataset.data[index] = allData[index];
                dataset.backgroundColor[index] = allColors[index];
            } else {
                statusChart.data.labels[index] = '';
                dataset.data[index] = 0;
                dataset.backgroundColor[index] = 'rgba(0,0,0,0)';
            }

            statusChart.update();
        });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    document.body.addEventListener('click', function (e) {
        if (e.target.classList.contains('page-link-ajax')) {
            e.preventDefault();
            const page = e.target.dataset.page;

            fetch(`{% url 'home_tasks_ajax' %}?page=${page}`, {
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('task-cards').innerHTML = html;
                window.scrollTo({ top: document.getElementById('task-cards').offsetTop - 100, behavior: 'smooth' });
            });
        }
    });
});
</script>
{% endblock %}
