{% extends 'base.html' %}
{% block title %}–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å | Flowvance{% endblock %}

{% block content %}
<h2 class="mb-4">üìä –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>

<div class="row g-4 mb-5">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="col-md-4">
        <div class="card p-3 shadow-sm">
            <h5>–í—Å–µ–≥–æ –∑–∞–¥–∞—á: {{ total }}</h5>
            <h6>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: {{ completed }}</h6>
            <h6>üìå –û—Å—Ç–∞–ª–æ—Å—å: {{ remaining }}</h6>
            <h6>‚è∞ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: {{ overdue }}</h6>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->
    <div class="col-md-8">
        <canvas id="statusChart" height="180"></canvas>
    </div>
</div>

<!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
<h4 class="mb-3">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–¥–∞—á</h4>
<div id="calendar" class="mb-5"></div>
<a href="{% url 'home' %}" class="btn btn-primary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>

<!-- JS: –°—Ç–∞—Ç—É—Å—ã -->
<script>
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const statusChart = new Chart(statusCtx, {
        type: 'bar',
        data: {
            labels: ['–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ', '–í –ø—Ä–æ—Ü–µ—Å—Å–µ', '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'],
            datasets: [{
                label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á',
                data: [{{ not_done }}, {{ in_progress }}, {{ completed }}],
                backgroundColor: ['rgba(220, 53, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(40, 167, 69, 0.7)'],
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    stepSize: 1
                }
            }
        }
    });
</script>

<!-- JS: –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ru',
            height: 600,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: ''
            },
            events: '/activity/calendar/data/',
            eventDidMount: function(info) {
                const tooltip = `${info.event.title} ‚Äî ${info.event.extendedProps.status}`;
                info.el.title = tooltip;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
                const status = info.event.extendedProps.status;
                if (status === '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ') {
                    info.el.style.backgroundColor = 'rgba(220, 53, 69, 0.7)';
                } else if (status === '–í –ø—Ä–æ—Ü–µ—Å—Å–µ') {
                    info.el.style.backgroundColor = 'rgba(255, 193, 7, 0.7)';
                } else if (status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ') {
                    info.el.style.backgroundColor = 'rgba(40, 167, 69, 0.7)';
                }
            },
            dateClick: function(info) {
                const date = info.dateStr;
                window.location.href = `/tasks/new/?date=${date}`;
            },
            eventClick: function(info) {
                const taskId = info.event.extendedProps.task_id;
                if (taskId) {
                    window.location.href = `/tasks/edit/${taskId}/`;
                }
            }
        });
        calendar.render();
    });
</script>
{% endblock %}
